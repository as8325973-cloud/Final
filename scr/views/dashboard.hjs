<!DOCTYPE html>

<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <!-- çµ±ä¸€å¼•å…¥è³‡æº -->

    <link rel="stylesheet" href="/bootstrap.min.css">
    <link rel="stylesheet" href="/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/app.css">

    <script src="/htmx.min.js"></script>
    <script src="/bootstrap.bundle.min.js"></script>
    <script src="/js/dashboard.js"></script>


</head>

<body>

    {{> navbar}}

    <div class="container mt-4">

        <!-- ç‹€æ…‹è¨Šæ¯å®¹å™¨ (ç”¨æ–¼ CRUD æ“ä½œå›å‚³è¨Šæ¯) -->

        <div id="statusMessageContainer" class="fixed-top-0 end-0 p-3" style="z-index: 1050;"></div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">MMR æŒ‡æ¨™è³‡æ–™åˆ†æé¢æ¿</h2>
        </div>

        <p class="text-muted">æ­¡è¿å›ä¾†ï¼Œ{{#user}}{{name}}{{/user}}ã€‚</p>

        <div class="row">

            <!-- å·¦å´æ¬„ä½: æŸ¥è©¢èˆ‡è¦–è¦ºåŒ–åŠŸèƒ½ (1, 2, 3, 4, 8) -->

            <div class="col-lg-8">

                <!-- åŠŸèƒ½ 8 â€” å…¨çƒå¹³å‡ MMR è¶¨å‹¢åœ– (è‡ªé¸åŠŸèƒ½) -->
                <div class="card mb-4 bg-light shadow-sm">
                    <div class="card-header fw-bold bg-primary text-white"> å…¨çƒå¹³å‡ MMR è¶¨å‹¢åœ– (Global Average)</div>
                    <div class="card-body">
                        <p class="card-text text-muted">é¡¯ç¤ºå…¨çƒå„å¹´åº¦å¹³å‡å­•ç”¢å©¦æ­»äº¡ç‡çš„è¶¨å‹¢ã€‚</p>
                        <!-- åœ–è¡¨ Canvas -->
                        <div style="height: 350px;"><canvas id="globalAverageChart"></canvas></div>
                    </div>
                </div>

                <!-- åŠŸèƒ½ 1 â€” ä¾åœ‹å®¶æŸ¥è©¢æ­·å¹´ MMR -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header fw-bold"> ä¾åœ‹å®¶æŸ¥è©¢æ­·å¹´ MMR (ç”±å°åˆ°å¤§æ’åº)</div>
                    <div class="card-body">
                        <label for="countrySelect1" class="form-label">é¸æ“‡åœ‹å®¶</label>
                        <!-- hx-trigger="change, mmrUpdated"ï¼šé¸å–®æ”¹è®Šæˆ– MMR è³‡æ–™æ›´æ–°æ™‚è§¸ç™¼é‡æ–°è¼‰å…¥ -->
                        <select id="countrySelect1" name="alpha3" class="form-select mb-3"
                            hx-get="/api/mmr/history/{{value}}" hx-target="#countryHistoryTable" hx-swap="innerHTML"
                            hx-indicator="#loadingIndicator1" hx-trigger="change, mmrUpdated">
                            <option value="undefined">-- è«‹é¸æ“‡åœ‹å®¶ --</option>
                        </select>
                        <span id="loadingIndicator1"
                            class="spinner-border spinner-border-sm text-primary htmx-indicator" role="status"
                            aria-hidden="true"></span>

                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr class="table-primary">
                                    <th>å¹´ä»½</th>
                                    <th>MMR </th>
                                </tr>
                            </thead>
                            <tbody id="countryHistoryTable">
                                <tr>
                                    <td colspan="2">è«‹é¸æ“‡ä¸€å€‹åœ‹å®¶ä¾†æŸ¥çœ‹æ­·å²æ•¸æ“š</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- åŠŸèƒ½ 4 â€” åœ‹å®¶åç¨±é—œéµå­—æœå°‹ -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header fw-bold"> åœ‹å®¶åç¨±é—œéµå­—æœå°‹ (æœ€æ–° MMRï¼Œé«˜åˆ°ä½æ’åº)</div>
                    <div class="card-body">
                        <label for="searchKeyword" class="form-label">åœ‹å®¶åç¨±é—œéµå­— (è‡³å°‘ 2 å€‹å­—å…ƒ)</label>
                        <!-- hx-trigger="input changed delay:500ms"ï¼šè¼¸å…¥åœæ­¢ 500ms å¾Œç™¼é€è«‹æ±‚ -->
                        <input type="search" id="searchKeyword" class="form-control mb-3" name="keyword"
                            hx-get="/api/search/country" hx-target="#searchResultTable"
                            hx-trigger="input changed delay:500ms, mmrUpdated" hx-indicator="#loadingIndicator4"
                            placeholder="ä¾‹å¦‚ï¼šChina, Canada...">
                        <span id="loadingIndicator4"
                            class="spinner-border spinner-border-sm text-primary htmx-indicator" role="status"
                            aria-hidden="true"></span>

                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr class="table-primary">
                                    <th>åœ‹å®¶åç¨±</th>
                                    <th>ä»£ç¢¼ </th>
                                    <th>æœ€æ–° MMR</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultTable">
                                <tr>
                                    <td colspan="3">è«‹è¼¸å…¥é—œéµå­—é€²è¡Œæœå°‹</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- åŠŸèƒ½ 2 & 3: æ¬¡å€åŸŸå’Œå€åŸŸæŸ¥è©¢ -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header fw-bold">æŸ¥è©¢æ¯”è¼ƒåŠŸèƒ½</div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="subregion-tab" data-bs-toggle="tab"
                                    data-bs-target="#subregion-pane" type="button" role="tab"> æ¬¡å€åŸŸåœ‹å®¶ MMR</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="regionmax-tab" data-bs-toggle="tab"
                                    data-bs-target="#regionmax-pane" type="button" role="tab"> å€åŸŸæœ€å¤§ MMR</button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3" id="myTabContent">

                            <!-- åŠŸèƒ½ 2 â€” æŸ¥æŸ SubRegion åœ¨æŸå¹´çš„æ‰€æœ‰åœ‹å®¶ MMR -->
                            <div class="tab-pane fade show active" id="subregion-pane" role="tabpanel" tabindex="0">
                                <p class="text-muted">ä¾æŒ‡å®šçš„æ¬¡å€åŸŸå’Œå¹´ä»½ï¼Œåˆ—å‡ºæ‰€æœ‰åœ‹å®¶ MMR (é«˜åˆ°ä½)ã€‚</p>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="subRegionSelect" class="form-label">é¸æ“‡æ¬¡å€åŸŸ</label>
                                        <!-- hx-get ç¶å®šåˆ°æ¬¡å€åŸŸé¸å–®çš„ change äº‹ä»¶ -->
                                        <select id="subRegionSelect" class="form-select" name="subRegionCode"
                                            hx-get="/api/mmr/subregion/{{value}}/" hx-target="#subRegionYearTable"
                                            hx-swap="innerHTML" hx-indicator="#loadingIndicator2"
                                            hx-include="#subRegionYearSelect" hx-trigger="change, mmrUpdated">
                                            <option value="undefined">-- è«‹é¸æ“‡æ¬¡å€åŸŸ --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subRegionYearSelect" class="form-label">é¸æ“‡å¹´ä»½</label>
                                        <select id="subRegionYearSelect" class="form-select" name="year"
                                            hx-get="/api/mmr/subregion/" hx-target="#subRegionYearTable"
                                            hx-swap="innerHTML" hx-indicator="#loadingIndicator2"
                                            hx-include="#subRegionSelect" hx-trigger="change, mmrUpdated">
                                            <option value="undefined">-- è«‹é¸æ“‡å¹´ä»½ --</option>
                                        </select>
                                    </div>
                                </div>
                                <span id="loadingIndicator2"
                                    class="spinner-border spinner-border-sm text-primary htmx-indicator mt-2"
                                    role="status" aria-hidden="true"></span>

                                <table class="table table-bordered table-hover mt-3">
                                    <thead>
                                        <tr class="table-primary">
                                            <th>åœ‹å®¶</th>
                                            <th>MMR</th>
                                        </tr </thead>
                                    <tbody id="subRegionYearTable">
                                        <tr>
                                            <td colspan="2">è«‹é¸æ“‡æ¬¡å€åŸŸå’Œå¹´ä»½</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- åŠŸèƒ½ 3 â€” æŸ¥æŸ Region åœ¨æŸå¹´çš„æ‰€æœ‰ SubRegionã€Œæœ€å¤§ MMRã€ -->
                            <div class="tab-pane fade" id="regionmax-pane" role="tabpanel" tabindex="0">
                                <p class="text-muted">ä¾æŒ‡å®šçš„å€åŸŸå’Œå¹´ä»½ï¼Œé¡¯ç¤ºè©²å€åŸŸå…§å„æ¬¡å€åŸŸçš„æœ€é«˜ MMRã€‚</p>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="regionSelect" class="form-label">é¸æ“‡å€åŸŸ</label>
                                        <select id="regionSelect" class="form-select" name="regionCode"
                                            hx-get="/api/mmr/regionmax/{{value}}/" hx-target="#regionMaxTable"
                                            hx-swap="innerHTML" hx-indicator="#loadingIndicator3"
                                            hx-include="#regionYearSelect" hx-trigger="change, mmrUpdated">
                                            <option value="undefined">-- è«‹é¸æ“‡å€åŸŸ --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="regionYearSelect" class="form-label">é¸æ“‡å¹´ä»½</label>
                                        <select id="regionYearSelect" class="form-select" name="year"
                                            hx-get="/api/mmr/regionmax/" hx-target="#regionMaxTable" hx-swap="innerHTML"
                                            hx-indicator="#loadingIndicator3" hx-include="#regionSelect"
                                            hx-trigger="change, mmrUpdated">
                                            <option value="undefined">-- è«‹é¸æ“‡å¹´ä»½ --</option>
                                        </select>
                                    </div>
                                </div>
                                <span id="loadingIndicator3"
                                    class="spinner-border spinner-border-sm text-primary htmx-indicator mt-2"
                                    role="status" aria-hidden="true"></span>

                                <table class="table table-bordered table-hover mt-3">
                                    <thead>
                                        <tr class="table-primary">
                                            <th>æ¬¡å€åŸŸ</th>
                                            <th>æœ€é«˜ MMR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regionMaxTable">
                                        <tr>
                                            <td colspan="2">è«‹é¸æ“‡å€åŸŸå’Œå¹´ä»½</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


            </div> <!-- end col-lg-8 -->

            <!-- å³å´æ¬„ä½: CRUD åŠŸèƒ½ (5, 6, 7) -->

            <div class="col-lg-4">

                <!-- åŠŸèƒ½ 5 â€” æ–°å¢æŸåœ‹å®¶ä¸‹ä¸€å¹´åº¦çš„ MMR -->
                <div class="card mb-4 bg-success-subtle shadow-sm border-success">
                    <div class="card-header fw-bold text-success"> æ–°å¢ MMR è¨˜éŒ„</div>
                    <div class="card-body">
                        <!-- hx-post: ç™¼é€ POST è«‹æ±‚ -->
                        <form hx-post="/api/mmr/add" hx-target="#statusMessageContainer" hx-swap="beforeend">
                            <p class="text-muted small">ç³»çµ±å°‡è‡ªå‹•è¨ˆç®—ä¸‹ä¸€å¹´åº¦ï¼ˆéœ€ç¢ºä¿è©²å¹´è¨˜éŒ„ä¸å­˜åœ¨ï¼‰ã€‚</p>
                            <label for="addCountrySelect" class="form-label">åœ‹å®¶</label>
                            <select id="addCountrySelect" name="alpha3" class="form-select mb-3" required>
                                <option value="">-- è«‹é¸æ“‡åœ‹å®¶ --</option>
                            </select>

                            <label for="addMmr" class="form-label">MMR å€¼</label>
                            <input type="number" step="0.1" id="addMmr" name="mmr" class="form-control mb-3" required
                                placeholder="ä¾‹å¦‚ï¼š12.5">

                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus-circle"></i> æ–°å¢ä¸‹ä¸€å¹´åº¦è³‡æ–™
                            </button>
                        </form>
                    </div>
                </div>

                <!-- åŠŸèƒ½ 6 â€” æ›´æ–°æŸåœ‹å®¶æŸå¹´çš„ MMR -->
                <div class="card mb-4 bg-warning-subtle shadow-sm border-warning">
                    <div class="card-header fw-bold text-warning"> æ›´æ–° MMR è¨˜éŒ„</div>
                    <div class="card-body">
                        <!-- hx-post: ç™¼é€ POST è«‹æ±‚ -->
                        <form hx-post="/api/mmr/update" hx-target="#statusMessageContainer" hx-swap="beforeend">
                            <label for="updateCountrySelect" class="form-label">åœ‹å®¶</label>
                            <select id="updateCountrySelect" name="alpha3" class="form-select mb-3" required>
                                <option value="">-- è«‹é¸æ“‡åœ‹å®¶ --</option>
                            </select>

                            <label for="updateYear" class="form-label">å¹´ä»½</label>
                            <select id="updateYear" name="year" class="form-select mb-3" required>
                                <option value="">-- è«‹é¸æ“‡å¹´ä»½ --</option>
                            </select>

                            <label for="updateMmr" class="form-label">æ–° MMR å€¼</label>
                            <input type="number" step="0.1" id="updateMmr" name="mmr" class="form-control mb-3" required
                                placeholder="ä¾‹å¦‚ï¼š15.0">

                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-pencil-square"></i> æ›´æ–°æŒ‡å®šå¹´ä»½è³‡æ–™
                            </button>
                        </form>
                    </div>
                </div>

                <!-- åŠŸèƒ½ 7 â€” åˆªé™¤æŸåœ‹å®¶æŸå¹´ä»½å€é–“çš„ MMR -->
                <div class="card mb-4 bg-danger-subtle shadow-sm border-danger">
                    <div class="card-header fw-bold text-danger"> åˆªé™¤ MMR å€é–“è¨˜éŒ„</div>
                    <div class="card-body">
                        <!-- hx-delete: ç™¼é€ DELETE è«‹æ±‚ -->
                        <form hx-delete="/api/mmr/delete" hx-target="#statusMessageContainer" hx-swap="beforeend">
                            <label for="deleteCountrySelect" class="form-label">åœ‹å®¶</label>
                            <select id="deleteCountrySelect" name="alpha3" class="form-select mb-3" required>
                                <option value="">-- è«‹é¸æ“‡åœ‹å®¶ --</option>
                            </select>

                            <div class="row g-3">
                                <div class="col-6">
                                    <label for="deleteYearStart" class="form-label">èµ·å§‹å¹´ä»½</label>
                                    <select id="deleteYearStart" name="year_start" class="form-select" required>
                                        <option value="">-- é¸æ“‡ --</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="deleteYearEnd" class="form-label">çµæŸå¹´ä»½</label>
                                    <select id="deleteYearEnd" name="year_end" class="form-select" required>
                                        <option value="">-- é¸æ“‡ --</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-danger w-100 mt-3">
                                <i class="bi bi-trash"></i> åˆªé™¤å€é–“è³‡æ–™
                            </button>
                        </form>
                    </div>
                </div>


            </div> <!-- end col-lg-4 -->
        </div> <!-- end row -->

        <footer class="text-center text-muted mt-5 py-3 border-top">
            <p>&copy; 2025 MMR Visualization Project. Data from UN World Population Prospects.</p>
        </footer>

    </div>

    <!-- ğŸ’¡ ä¿®æ­£ Chart.js å¼•ç”¨ -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- è…³æœ¬å€å¡Šï¼šåˆå§‹åŒ–é¸å–®å’Œåœ–è¡¨ -->
    <script>
        // ç²å–åœ‹å®¶ã€æ¬¡å€åŸŸã€å€åŸŸåˆ—è¡¨ä¸¦å¡«å……é¸å–®
        document.addEventListener('DOMContentLoaded', async () => {
            const fetchAndPopulateSelect = async (url, selectIds, valueKey = 'alpha3', textKey = 'name') => {
                try {
                    const response = await fetch(url);
                    // æª¢æŸ¥ API æ˜¯å¦æˆåŠŸ
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();

                    // æª¢æŸ¥è³‡æ–™æ˜¯å¦ç‚ºç©º
                    if (!data || data.length === 0) {
                        console.warn(`No data returned from ${url}`);
                        return;
                    }

                    selectIds.forEach(id => {
                        const select = document.getElementById(id);
                        if (!select) return;

                        // æ¸…ç©ºç¾æœ‰é¸é … (ä¿ç•™é è¨­ 'è«‹é¸æ“‡')
                        while (select.options.length > 1) {
                            select.remove(1);
                        }

                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item[valueKey];
                            option.textContent = item[textKey];
                            select.appendChild(option);
                        });
                    });
                } catch (error) {
                    console.error(`Error fetching data from ${url}:`, error);
                    selectIds.forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>';
                            select.style.borderColor = 'red'; // æ¨™è¨˜ç´…è‰²é‚Šæ¡†æç¤ºéŒ¯èª¤
                        }
                    });
                }
            };

            // 1. å¡«å……åœ‹å®¶é¸å–® (åŠŸèƒ½ 1, 5, 6, 7)
            await fetchAndPopulateSelect('/api/countries', ['countrySelect1', 'addCountrySelect', 'updateCountrySelect', 'deleteCountrySelect']);

            // 2. å¡«å……æ¬¡å€åŸŸé¸å–® (åŠŸèƒ½ 2)
            await fetchAndPopulateSelect('/api/subregions', ['subRegionSelect'], 'sub_region_code', 'sub_region_name');

            // 3. å¡«å……å€åŸŸé¸å–® (åŠŸèƒ½ 3)
            await fetchAndPopulateSelect('/api/regions', ['regionSelect'], 'region_code', 'region_name');

            // 4. å¡«å……å¹´ä»½é¸å–® (ç°¡å–®ç”Ÿæˆ 1990-2025)
            // 4. CRUD ç”¨å¹´ä»½é¸å–®ï¼ˆä¿ç•™å¯«æ­» 1990-2025ï¼‰
            // âš ï¸ æ³¨æ„ï¼šé€™è£¡ä¸è¦å†åŒ…å« subRegionYearSelect / regionYearSelect
            const yearSelectIds = ['updateYear', 'deleteYearStart', 'deleteYearEnd'];
            yearSelectIds.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;

                while (select.options.length > 1) {
                    select.remove(1);
                }
                for (let y = 2025; y >= 1990; y--) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    select.appendChild(option);
                }
            });

            // âœ… å‹•æ…‹æ›´æ–°å¹´ä»½é¸å–®ï¼ˆä¿ç•™ç¬¬ 1 å€‹ placeholderï¼‰
            const replaceYearOptions = (selectId, years) => {
                const select = document.getElementById(selectId);
                if (!select) return;

                while (select.options.length > 1) {
                    select.remove(1);
                }

                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y;
                    select.appendChild(opt);
                });
            };

            // âœ… ç•¶é¸æ“‡ Region æ™‚ï¼Œè¼‰å…¥è©² Region æœ‰è³‡æ–™çš„å¹´ä»½
            const regionSelectEl = document.getElementById('regionSelect');
            if (regionSelectEl) {
                regionSelectEl.addEventListener('change', async () => {
                    const regionCode = regionSelectEl.value;

                    // å¦‚æœé‚„æ˜¯ placeholderï¼Œå°±æ¸…ç©ºå¹´ä»½ï¼ˆåªç•™ç¬¬ä¸€å€‹é¸é …ï¼‰
                    if (!regionCode || regionCode === 'undefined') {
                        replaceYearOptions('regionYearSelect', []);
                        return;
                    }

                    try {
                        const resp = await fetch(`/api/years/region?regionCode=${encodeURIComponent(regionCode)}`);
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const rows = await resp.json();        // [{year: 2020}, ...]
                        const years = rows.map(r => r.year);   // [2020, 2019, ...]
                        replaceYearOptions('regionYearSelect', years);
                    } catch (e) {
                        console.error("load region years failed:", e);
                        replaceYearOptions('regionYearSelect', []);
                    }
                });
            }

            // ï¼ˆå¯é¸ï¼‰ç•¶é¸æ“‡ SubRegion æ™‚ï¼Œè¼‰å…¥è©² SubRegion æœ‰è³‡æ–™çš„å¹´ä»½
            const subRegionSelectEl = document.getElementById('subRegionSelect');
            if (subRegionSelectEl) {
                subRegionSelectEl.addEventListener('change', async () => {
                    const subRegionCode = subRegionSelectEl.value;

                    if (!subRegionCode || subRegionCode === 'undefined') {
                        replaceYearOptions('subRegionYearSelect', []);
                        return;
                    }

                    try {
                        const resp = await fetch(`/api/years/subregion?subRegionCode=${encodeURIComponent(subRegionCode)}`);
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const rows = await resp.json();
                        const years = rows.map(r => r.year);
                        replaceYearOptions('subRegionYearSelect', years);
                    } catch (e) {
                        console.error("load subregion years failed:", e);
                        replaceYearOptions('subRegionYearSelect', []);
                    }
                });
            }


            // 5. å‘¼å«åœ–è¡¨åˆå§‹åŒ–
            initGlobalAverageChart();
        });

        let globalChartInstance = null;

        // åŠŸèƒ½ 8: å…¨çƒå¹³å‡ MMR åœ–è¡¨åˆå§‹åŒ–
        const initGlobalAverageChart = async () => {
            const ctx = document.getElementById('globalAverageChart');
            if (!ctx) return;

            try {
                const response = await fetch('/api/mmr/global-average');
                if (!response.ok) throw new Error("API Network response was not ok");

                const data = await response.json();

                if (!data || data.length === 0) {
                    throw new Error("No data available for chart");
                }

                const years = data.map(item => item.year);
                const averages = data.map(item => item.avg_mmr ? item.avg_mmr.toFixed(1) : 0);

                // å¦‚æœåœ–è¡¨å·²å­˜åœ¨ï¼Œå‰‡éŠ·æ¯€å®ƒ (é¿å…é‡è¤‡ç¹ªè£½)
                if (globalChartInstance) {
                    globalChartInstance.destroy();
                }

                globalChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'å…¨çƒå¹³å‡ MMR (per 100,000 live births)',
                            data: averages,
                            borderColor: 'rgb(13, 110, 253)',
                            backgroundColor: 'rgba(13, 110, 253, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'MMR (per 100,000 live births)'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        }
                    }
                });

            } catch (error) {
                console.error("Error drawing global average chart:", error);
                // åœ¨åœ–è¡¨å€åŸŸé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                ctx.parentNode.innerHTML = `<div class="alert alert-warning d-flex align-items-center" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  <div>ç„¡æ³•è¼‰å…¥åœ–è¡¨æ•¸æ“š: ${error.message}</div>
              </div>`;
            }
        };

        // ç›£è½ mmrUpdated äº‹ä»¶ (ç”± HTMX è§¸ç™¼)ï¼Œé‡æ–°è¼‰å…¥åœ–è¡¨å’ŒåŠŸèƒ½ 1 (å¦‚æœå·²é¸åœ‹å®¶)
        document.body.addEventListener('mmrUpdated', (e) => {
            console.log('MMR Data Updated, refreshing...');

            // é‡æ–°ç¹ªè£½åœ–è¡¨ (åŠŸèƒ½ 8)
            initGlobalAverageChart();

            // é‡æ–°è§¸ç™¼åŠŸèƒ½ 1, 2, 3, 4 çš„ HTMX è«‹æ±‚ä»¥æ›´æ–°è¡¨æ ¼
            const triggerElements = ['countrySelect1', 'searchKeyword', 'subRegionSelect', 'regionSelect'];
            triggerElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // æª¢æŸ¥æ˜¯å¦ç‚º input (search) æˆ– select
                    if (el.tagName === 'SELECT' && el.value !== 'undefined' && el.value !== '') {
                        htmx.trigger(el, "change");
                    } else if (el.tagName === 'INPUT' && el.value && el.value.length >= 2) {
                        htmx.trigger(el, "input");
                    }
                }
            });

            // 5ç§’å¾Œæ¸…é™¤ç‹€æ…‹è¨Šæ¯
            setTimeout(() => {
                const container = document.getElementById('statusMessageContainer');
                if (container) container.innerHTML = '';
            }, 5000);
        });
    </script>
</body>

</html>