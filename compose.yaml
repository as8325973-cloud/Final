# 注意：Compose v2 之後 version 其實可省略，但保留也能跑
# 如果你想消除警告，可以把 version 這行刪掉
version: "3.8"

name: FinalApp

services:
  mysql:
    image: mysql:8.0
    container_name: mysql_db

    # 連到同一個 network，webapp 可用 host: mysql 連線
    networks:
      final-app:
        aliases:
          - mysql

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}

    # ✅ 健康檢查建議加上 root 密碼，避免某些情況 ping 不穩定
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 20s

    volumes:
      # ✅ 這裡用的 volume 名稱是 FinalVolume，所以底下 volumes 也要叫 FinalVolume
      - FinalVolume:/var/lib/mysql

      # ✅ 初始化 SQL：確保是 .sql 並放進 initdb.d
      # 注意：這個只會在「資料庫第一次初始化」時執行
      - ./Final_Latest.sql:/docker-entrypoint-initdb.d/Final_Latest.sql:ro

  webapp:
    build: .
    container_name: final_webapp

    depends_on:
      mysql:
        condition: service_healthy

    ports:
      - "8080:80"

    networks:
      - final-app

    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}

volumes:
  # ✅ 這裡名稱要跟上面一模一樣：FinalVolume
  FinalVolume:

networks:
  final-app:
    driver: bridge
